<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History - Solar Power Monitor</title>
  <link rel="stylesheet" href="styles/common.css">
  <link rel="stylesheet" href="styles/history.css">
  <script src="scripts/moment.min.js"></script>
  <script src="scripts/Chart.js"></script>
</head>
<body>
  <div id="header">
    <h1>Solar Power History</h1>
    <a href="/" class="header-link">‚Üê Back to Live Monitor</a>
    <a href="/calibration" class="header-link">Calibration</a>
    <a href="/wifi" class="header-link">WiFi</a>
  </div>

  <div id="tabs">
    <button class="tab-button active" onclick="switchTab('minute')">Last Hour (per minute)</button>
    <button class="tab-button" onclick="switchTab('hourly')">Last 24 Hours (per hour)</button>
    <button class="tab-button toggle-btn" id="minMaxToggle" onclick="toggleMinMax()">Show Min/Max</button>
  </div>

  <div id="content">
    <div class="status">
      <span class="status-text" id="statusText">Loading...</span>
    </div>

    <div id="minuteTab" class="tab-content active">
      <div class="info-box">
        <p><strong>Last Hour:</strong> Shows voltage and current averaged per minute. Hover over points to see min/max values. Toggle "Show Min/Max" to display range bands.</p>
      </div>
      <div id="charts">
        <div class="chart-container"><canvas id="minuteBatteryChart"></canvas></div>
        <div class="chart-container"><canvas id="minuteLoadChart"></canvas></div>
        <div class="chart-container"><canvas id="minuteSolarChart"></canvas></div>
      </div>
    </div>

    <div id="hourlyTab" class="tab-content">
      <div class="info-box">
        <p><strong>Last 24 Hours:</strong> Shows voltage and current averaged per hour. Hover over points to see min/max values. Toggle "Show Min/Max" to display range bands.</p>
      </div>
      <div id="charts">
        <div class="chart-container"><canvas id="hourlyBatteryChart"></canvas></div>
        <div class="chart-container"><canvas id="hourlyLoadChart"></canvas></div>
        <div class="chart-container"><canvas id="hourlySolarChart"></canvas></div>
      </div>
    </div>
  </div>

  <script>
    Chart.defaults.global.defaultFontColor='#ffffff';
    var showMinMax=false;

    function hexToRgba(hex,alpha){
      var r=parseInt(hex.slice(1,3),16);
      var g=parseInt(hex.slice(3,5),16);
      var b=parseInt(hex.slice(5,7),16);
      return 'rgba('+r+','+g+','+b+','+alpha+')';
    }

    function createHistoryChart(id,title,vc,cc,pc){
      return new Chart(document.getElementById(id),{type:'line',data:{datasets:[
        // Voltage line (index 0)
        {label:'Voltage (V)',backgroundColor:'rgba(0,0,0,0)',borderColor:vc,data:[],yAxisID:'voltage-axis',borderWidth:2,pointRadius:2,lineTension:0.1,fill:false},
        // Voltage min band (index 1) - hidden by default
        {label:'V Min',borderColor:'transparent',backgroundColor:hexToRgba(vc,0.15),data:[],yAxisID:'voltage-axis',borderWidth:0,pointRadius:0,lineTension:0.1,fill:'+1',hidden:true},
        // Voltage max band (index 2) - hidden by default
        {label:'V Max',borderColor:'transparent',backgroundColor:'transparent',data:[],yAxisID:'voltage-axis',borderWidth:0,pointRadius:0,lineTension:0.1,fill:false,hidden:true},
        // Current line (index 3)
        {label:'Current (A)',backgroundColor:'rgba(0,0,0,0)',borderColor:cc,data:[],yAxisID:'current-axis',borderWidth:2,pointRadius:2,lineTension:0.1,fill:false},
        // Current min band (index 4) - hidden by default
        {label:'I Min',borderColor:'transparent',backgroundColor:hexToRgba(cc,0.15),data:[],yAxisID:'current-axis',borderWidth:0,pointRadius:0,lineTension:0.1,fill:'+1',hidden:true},
        // Current max band (index 5) - hidden by default
        {label:'I Max',borderColor:'transparent',backgroundColor:'transparent',data:[],yAxisID:'current-axis',borderWidth:0,pointRadius:0,lineTension:0.1,fill:false,hidden:true},
        // Power line (index 6)
        {label:'Power (W)',backgroundColor:'rgba(0,0,0,0)',borderColor:pc,data:[],yAxisID:'power-axis',borderWidth:2,pointRadius:2,lineTension:0.1,fill:false}
      ]},options:{maintainAspectRatio:false,title:{display:true,text:title,fontSize:16,fontColor:'#4CAF50'},legend:{display:true,labels:{fontColor:'#fff',fontSize:11,filter:function(item){return !item.text.includes('Min')&&!item.text.includes('Max');}}},
      scales:{xAxes:[{type:'time',time:{unit:'minute',displayFormats:{minute:'HH:mm'},tooltipFormat:'MMM D, HH:mm'},ticks:{fontColor:'#999',maxRotation:45},gridLines:{color:'#3d3d3d'}}],
      yAxes:[{id:'voltage-axis',type:'linear',position:'left',scaleLabel:{display:true,labelString:'Voltage (V)',fontColor:vc},ticks:{fontColor:vc,beginAtZero:false,maxTicksLimit:5,callback:function(value,index,values){if(index>0&&value.toFixed(3)===values[index-1].toFixed(3))return '';return value.toFixed(3);}},gridLines:{color:'#3d3d3d'}},
      {id:'current-axis',type:'linear',position:'left',scaleLabel:{display:true,labelString:'Current (A)',fontColor:cc},ticks:{fontColor:cc,beginAtZero:true,maxTicksLimit:5,callback:function(value,index,values){if(index>0&&value.toFixed(3)===values[index-1].toFixed(3))return '';return value.toFixed(3);}},gridLines:{display:false}},
      {id:'power-axis',type:'linear',position:'right',scaleLabel:{display:true,labelString:'Power (W)',fontColor:pc},ticks:{fontColor:pc,beginAtZero:true,maxTicksLimit:5,callback:function(value,index,values){if(index>0&&value.toFixed(3)===values[index-1].toFixed(3))return '';return value.toFixed(3);}},gridLines:{display:false}}]},
      animation:{duration:500},hover:{animationDuration:200},tooltips:{mode:'index',intersect:false,backgroundColor:'rgba(0,0,0,0.9)',titleFontColor:'#fff',bodyFontColor:'#fff',filter:function(item){return !item.datasetIndex||![1,2,4,5].includes(item.datasetIndex);},callbacks:{label:function(tooltipItem,data){
        var ds=data.datasets[tooltipItem.datasetIndex];
        var label=ds.label||'';
        var pt=ds.data[tooltipItem.index];
        var val=tooltipItem.yLabel.toFixed(3);
        if(pt&&pt.min!==undefined&&pt.max!==undefined){
          return label+': '+val+' (min: '+pt.min.toFixed(3)+', max: '+pt.max.toFixed(3)+')';
        }
        return label+': '+val;
      }}}}});
    }

    var minuteBatteryChart=null;
    var minuteSolarChart=null;
    var minuteLoadChart=null;
    var hourlyBatteryChart=null;
    var hourlySolarChart=null;
    var hourlyLoadChart=null;
    var chartsInitialized=false;

    function initializeCharts(){
      if(chartsInitialized)return;
      minuteBatteryChart=createHistoryChart('minuteBatteryChart','Battery','#FFB74D','#4FC3F7','#81C784');
      minuteSolarChart=createHistoryChart('minuteSolarChart','Solar Panel','#FFA726','#29B6F6','#66BB6A');
      minuteLoadChart=createHistoryChart('minuteLoadChart','Load','#FF9800','#03A9F4','#4CAF50');
      hourlyBatteryChart=createHistoryChart('hourlyBatteryChart','Battery','#FFB74D','#4FC3F7','#81C784');
      hourlySolarChart=createHistoryChart('hourlySolarChart','Solar Panel','#FFA726','#29B6F6','#66BB6A');
      hourlyLoadChart=createHistoryChart('hourlyLoadChart','Load','#FF9800','#03A9F4','#4CAF50');
      chartsInitialized=true;
    }

    function switchTab(tab){
      document.querySelectorAll('.tab-button:not(.toggle-btn)').forEach(btn=>btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content=>content.classList.remove('active'));

      if(tab==='minute'){
        document.querySelectorAll('.tab-button')[0].classList.add('active');
        document.getElementById('minuteTab').classList.add('active');
        if(minuteBatteryChart)minuteBatteryChart.update();
        if(minuteSolarChart)minuteSolarChart.update();
        if(minuteLoadChart)minuteLoadChart.update();
      }else if(tab==='hourly'){
        document.querySelectorAll('.tab-button')[1].classList.add('active');
        document.getElementById('hourlyTab').classList.add('active');
        if(hourlyBatteryChart)hourlyBatteryChart.update();
        if(hourlySolarChart)hourlySolarChart.update();
        if(hourlyLoadChart)hourlyLoadChart.update();
      }
    }

    function toggleMinMax(){
      showMinMax=!showMinMax;
      document.getElementById('minMaxToggle').classList.toggle('active',showMinMax);
      var charts=[minuteBatteryChart,minuteSolarChart,minuteLoadChart,hourlyBatteryChart,hourlySolarChart,hourlyLoadChart];
      charts.forEach(function(chart){
        if(!chart)return;
        // Toggle visibility of min/max band datasets (indices 1,2 for voltage, 4,5 for current)
        chart.data.datasets[1].hidden=!showMinMax;
        chart.data.datasets[2].hidden=!showMinMax;
        chart.data.datasets[4].hidden=!showMinMax;
        chart.data.datasets[5].hidden=!showMinMax;
        chart.update();
      });
    }

    function updateChart(chart,data){
      if(!chart)return;
      // Voltage with min/max metadata (index 0)
      chart.data.datasets[0].data=data.map(function(d){return {x:new Date(d.time*1000),y:d.voltage,min:d.voltageMin,max:d.voltageMax};});
      // Voltage min band (index 1)
      chart.data.datasets[1].data=data.map(function(d){return {x:new Date(d.time*1000),y:d.voltageMin};});
      // Voltage max band (index 2)
      chart.data.datasets[2].data=data.map(function(d){return {x:new Date(d.time*1000),y:d.voltageMax};});
      // Current with min/max metadata (index 3)
      chart.data.datasets[3].data=data.map(function(d){return {x:new Date(d.time*1000),y:d.current,min:d.currentMin,max:d.currentMax};});
      // Current min band (index 4)
      chart.data.datasets[4].data=data.map(function(d){return {x:new Date(d.time*1000),y:d.currentMin};});
      // Current max band (index 5)
      chart.data.datasets[5].data=data.map(function(d){return {x:new Date(d.time*1000),y:d.currentMax};});
      // Power with calculated min/max (index 6)
      chart.data.datasets[6].data=data.map(function(d){
        var pwr=d.voltage*d.current;
        var pwrMin=d.voltageMin*d.currentMin;
        var pwrMax=d.voltageMax*d.currentMax;
        return {x:new Date(d.time*1000),y:pwr,min:pwrMin,max:pwrMax};
      });
      chart.update();
    }

    function loadHistory(){
      Promise.all([
        fetch('/history-minute').then(r=>r.json()),
        fetch('/history-hourly').then(r=>r.json())
      ]).then(([minuteData,hourlyData])=>{
        const statusEl=document.getElementById('statusText');
        statusEl.classList.remove('error');
        statusEl.classList.remove('loaded');

        if(minuteData.length===0&&hourlyData.length===0){
          statusEl.textContent='No history data: NTP time not synced';
          statusEl.classList.add('error');
          return;
        }

        initializeCharts();

        if(minuteData.length>0){
          var battData=minuteData.map(d=>({time:d.t,voltage:d.bt.v,current:d.bt.i,voltageMin:d.bt.vn,voltageMax:d.bt.vx,currentMin:d.bt.in,currentMax:d.bt.ix}));
          var solarData=minuteData.map(d=>({time:d.t,voltage:d.pv.v,current:d.pv.i,voltageMin:d.pv.vn,voltageMax:d.pv.vx,currentMin:d.pv.in,currentMax:d.pv.ix}));
          var loadData=minuteData.map(d=>({time:d.t,voltage:d.ld.v,current:d.ld.i,voltageMin:d.ld.vn,voltageMax:d.ld.vx,currentMin:d.ld.in,currentMax:d.ld.ix}));
          updateChart(minuteBatteryChart,battData);
          updateChart(minuteSolarChart,solarData);
          updateChart(minuteLoadChart,loadData);
        }

        if(hourlyData.length>0){
          var battData=hourlyData.map(d=>({time:d.t,voltage:d.bt.v,current:d.bt.i,voltageMin:d.bt.vn,voltageMax:d.bt.vx,currentMin:d.bt.in,currentMax:d.bt.ix}));
          var solarData=hourlyData.map(d=>({time:d.t,voltage:d.pv.v,current:d.pv.i,voltageMin:d.pv.vn,voltageMax:d.pv.vx,currentMin:d.pv.in,currentMax:d.pv.ix}));
          var loadData=hourlyData.map(d=>({time:d.t,voltage:d.ld.v,current:d.ld.i,voltageMin:d.ld.vn,voltageMax:d.ld.vx,currentMin:d.ld.in,currentMax:d.ld.ix}));
          updateChart(hourlyBatteryChart,battData);
          updateChart(hourlySolarChart,solarData);
          updateChart(hourlyLoadChart,loadData);
        }

        statusEl.textContent='Last updated: '+new Date().toLocaleTimeString()+' ('+minuteData.length+' min / '+hourlyData.length+' hourly samples)';
        statusEl.classList.add('loaded');
      }).catch(err=>{
        const statusEl=document.getElementById('statusText');
        statusEl.textContent='Error loading history';
        statusEl.classList.add('error');
        console.error(err);
      });
    }

    loadHistory();
    setInterval(loadHistory,10000);
  </script>
</body>
</html>
